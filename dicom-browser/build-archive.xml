<project name="dicom.archive.NEW" default="distrib" basedir=".">

	<taskdef resource="net/sf/antcontrib/antlib.xml">
		<classpath>
			<pathelement location="lib/test/ant-contrib-1.0b3.jar" />
		</classpath>
	</taskdef>

	<property name="dir.src" value="src" />
	<property name="dir.bin" value="war/WEB-INF/classes" />
	<property name="dir.classes" value="classes" />
	<property name="dir.doc" value="doc" />
	<property name="dir.doc.api" value="${dir.doc}/api" />
	<property name="dir.distrib" value="distrib" />
	<property name="dir.data.db" value="data/db" />
	<property name="dir.data.incoming" value="data/incoming" />
	<property name="db.connect" value="jdbc:derby://localhost:1527//DICOM/DB/WEBDICOM;create=true" />
	<property name="distrib.jar" value="dcmarchive.jar" />

	<path id="derby.classpath">
		<fileset dir="lib/derby">
			<include name="**/*.jar" />
		</fileset>
	</path>

	<path id="dcm4che.classpath">
		<fileset dir="lib/dcm4che">
			<include name="**/*.jar" />
		</fileset>
	</path>

	<path id="common.classpath">
		<fileset dir="lib/common">
			<include name="**/*.jar" />
		</fileset>
	</path>

	<path id="build.classpath">
		<path refid="common.classpath" />
		<path refid="dcm4che.classpath" />
		<path refid="derby.classpath" />
	</path>

	<path id="dcmsend.classpath">
		<path refid="dcm4che.classpath" />
		<path refid="common.classpath" />
		<pathelement location="lib/test/dcm4che-tool-dcmsnd-2.0.21.jar" />
	</path>

	<path id="archive.classpath">
		<path refid="build.classpath" />
		<pathelement location="${dir.bin}" />
	</path>




	<!-- clean -->
	<target name="clean">
		<delete dir="${dir.classes}" />
	</target>

	<!-- prepare -->
	<target name="prepare" depends="clean">
		<mkdir dir="${dir.classes}" />
	</target>

	<!-- compile -->
	<target name="compile" depends="prepare">
		<!-- javac srcdir="${dir.src}" destdir="${dir.classes}" debug="on" encoding="UTF-8" -->
		<javac srcdir="${dir.src}" destdir="${dir.classes}" debug="on" nowarn="on" encoding="UTF-8">
			<classpath refid="build.classpath" />
			<include name="org/psystems/dicom/archive/**" />
			<exclude name="**/*Test.java" />
		</javac>
	</target>



	<!-- distrib -->
	<target name="distrib" depends="compile">


		<tstamp>
			<format property="today" pattern="yyyy/MM/dd HH:mm:ss" locale="en" />
		</tstamp>

		<copy todir="${dir.classes}">
			<fileset dir="${dir.src}">
				<exclude name="**/*.java" />
			</fileset>
		</copy>

		<jar destfile="${dir.distrib}/${distrib.jar}" basedir="${dir.classes}">
			<manifest>
				<attribute name="Build-By" value="${user.name}" />
				<attribute name="Build-Number" value="${revision.max}" />

				<section name="common">
					<attribute name="Specification-Title" value="Webdicom Archive" />
					<attribute name="Specification-Version" value="${today}" />
					<attribute name="Specification-Vendor" value="psystems.org" />
				</section>
			</manifest>
			<exclude name="**/*Test*" />
			<exclude name="**/log4j.properties " />
		</jar>
		<delete dir="${dir.classes}" />

	</target>


	<!-- start database -->
	<target name="db.ping" description="ping database">
		<echo message="Pinging DATABASE..." />
		<java classname="org.apache.derby.drda.NetworkServerControl" errorproperty="db.ping.error" outputproperty="db.ping.status" failonerror="true">
			<arg value="ping" />
			<sysproperty key="derby.system.home" value="${dir.data.db}" />
			<classpath refid="derby.classpath" />
		</java>
		<echo message="Pinging DATABASE ${db.ping.status} - ${db.ping.error}" />
	</target>



	<!-- start database -->
	<target name="db.start" description="start database">
		<echo message="Starting DATABASE..." />
		<mkdir dir="${dir.data.db}" />
		<java classname="org.apache.derby.drda.NetworkServerControl" fork="true" spawn="true">
			<arg value="start" />
			<sysproperty key="derby.system.home" value="${dir.data.db}" />
			<classpath refid="derby.classpath" />
		</java>
		<echo message="Starting DATABASE [OK]" />
	</target>



	<!-- stop database -->
	<target name="db.stop" description="stop database">

		<echo message="Stopping DATABASE..." />
		<java classname="org.apache.derby.drda.NetworkServerControl" fork="true" spawn="true">
			<arg value="shutdown" />
			<sysproperty key="derby.system.home" value="${dir.data.db}" />
			<classpath refid="derby.classpath" />
		</java>
		<echo message="Stopping DATABASE [OK]" />

	</target>



	<!-- remove database with incoming data -->
	<target name="db.instance.remove" depends="db.stop">

		<echo message="Removing DATABASE and ALL incoming data..." />

		<available file="${dir.data.db}"  property="dir.data.db.present"/>

		<if>
			<isset property="dir.data.db.present" />
			<then>
				<delete includeemptydirs="yes">
					<fileset dir="${dir.data.db}" />
				</delete>
			</then>
			<else>
				<echo message="${dir.data.db} does no exist"/>
			</else>
		</if>

		<available file="${dir.data.incoming}"  property="dir.data.incoming.present"/>

		<if>
			<isset property="dir.data.incoming.present" />
			<then>
				<delete includeemptydirs="yes">
					<fileset dir="${dir.data.incoming}" />
				</delete>
			</then>
			<else>
				<echo message="${dir.data.incoming} does no exist"/>
			</else>
		</if>

		<echo message="Removing DATABASE and ALL incoming data [OK]" />

	</target>

	<!-- create test database  -->
	<target name="db.instance.create" depends="db.instance.remove">

		<echo message="Creating DATABASE..." />

		<antcall target="db.start"/>

		<echo message="waiting 3 seconds start db..."/>
		<sleep seconds="3"/>
		<antcall target="db.ping"/>
		<java classname="org.apache.derby.tools.ij" output="${dir.data.db}/makedb.log">
			<arg value="database/derby/db.sql" />
			<sysproperty key="ij.exceptionTrace" value="true" />
			<sysproperty key="ij.showErrorCode" value="true" />
			<sysproperty key="derby.ui.locale" value="en_US" />
			<sysproperty key="derby.system.home" value="${dir.data.db}" />
			<sysproperty key="ij.database" value="${db.connect}" />
			<classpath refid="derby.classpath" />
		</java>

		<loadfile property="db.make.has.exceptions" srcfile="${dir.data.db}/makedb.log">
			<filterchain>
				<headfilter lines="1000" />
				<containsregex pattern="Exception" />
			</filterchain>
		</loadfile>
		<echo message="${db.make.has.exceptions}" />

		<if>
			<isset property="db.make.has.exceptions" />
			<then>
				<echo message="MAKE DB HAS ERROR" />
			</then>
			<else>
			</else>
		</if>

		<fail message="MAKE DB ERROR!">
			<condition>
				<isset property="db.make.has.exceptions" />
			</condition>
		</fail>

		<echo message="Creating DATABASE [OK]" />

	</target>


	<!-- start archive -->
	<target name="archve.start" description="start dicom archive">

		<echo message="Starting DICOM Archive..."/>
		<java classname="org.psystems.dicom.archive.Archive" fork="true" spawn="false">
			<sysproperty key="webdicom.home" value="distrib" />
			<sysproperty key="log4j.configuration" value="log4j.properties" />
			<sysproperty key="derby.system.home" value="${dir.data.db}" />
			<sysproperty key="derby.drda.startNetworkServer" value="true" />
			<sysproperty key="derby.drda.portNumber" value="1527" />
			<sysproperty key="derby.drda.host" value="localhost" />
			<sysproperty key="derby.drda.logConnections" value="true" />
			<classpath refid="archive.classpath" />
			<classpath refid="derby.classpath" />
		</java>
		<echo message="Starting DICOM Archive [OK]"/>
	</target>


	<target name="archve.test" description="start dicom archivr">
		<parallel failonany="true">
			<antcall target="archve.start"/>
			<sequential>
				<echo message="test1"/>
				<sleep seconds="1"/>
				<echo message="test2"/>
				<sleep seconds="1"/>
				<echo message="test3"/>
				<sleep seconds="1"/>
			</sequential>
		</parallel>
	</target>


	<!-- send to archive -->
	<target name="send2archive" description="Отправка dcm-файла в архив">
		<echo message="file=${file}" />
		<java classname="org.dcm4che2.tool.dcmsnd.DcmSnd">
			<arg value="MAIN@localhost:11112" />
			<arg value="${file}" />
			<classpath refid="dcmsend.classpath" />
		</java>
	</target>

	<!-- fill database test studies -->
	<target name="db.fill" description="заливка тестовых исследваний">

		<for param="file">
			<path>
				<fileset dir="test/data" includes="**/*.dcm" />
			</path>
			<sequential>
				<antcall target="send2archive">
					<param name="file" value="@{file}" />
				</antcall>
			</sequential>
		</for>

	</target>



</project>

