<project name="dicom.archive.NEW" default="distrib" basedir=".">

	<taskdef resource="net/sf/antcontrib/antlib.xml">
		<classpath>
			<pathelement location="lib/test/ant-contrib-1.0b3.jar" />
		</classpath>
	</taskdef>

	<property name="dir.src" value="src" />
	<property name="dir.bin" value="bin" />
	<property name="dir.classes" value="classes" />
	<property name="dir.doc" value="doc" />
	<property name="dir.doc.api" value="${dir.doc}/api" />
	<property name="dir.distrib" value="distrib" />
	<property name="dir.instance" value="database/instance" />
	<property name="db.connect" value="jdbc:derby://localhost:1527//DICOM/DB/WEBDICOM;create=true" />
	<property name="distrib.jar" value="dcmarchive.jar" />

	<path id="derby.classpath">
		<fileset dir="lib/derby">
			<include name="**/*.jar" />
		</fileset>
	</path>

	<path id="dcm4che.classpath">
		<fileset dir="lib/dcm4che">
			<include name="**/*.jar" />
		</fileset>
	</path>

	<path id="common.classpath">
		<fileset dir="lib/common">
			<include name="**/*.jar" />
		</fileset>
	</path>

	<path id="build.classpath">
		<path refid="dcm4che.classpath" />
		<path refid="common.classpath" />
	</path>

	<path id="dcmsend.classpath">
		<path refid="dcm4che.classpath" />
		<pathelement location="test/dcm4che-tool-dcmsnd-2.0.21.jar" />
	</path>

	<path id="archive.classpath">
		<path refid="build.classpath" />
		<pathelement location="${dir.bin}" />
	</path>




	<!-- clean -->
	<target name="clean">
		<delete dir="${dir.classes}" />
	</target>

	<!-- prepare -->
	<target name="prepare" depends="clean">
		<mkdir dir="${dir.classes}" />
	</target>

	<!-- compile -->
	<target name="compile" depends="prepare">
		<!-- javac srcdir="${dir.src}" destdir="${dir.classes}" debug="on" encoding="UTF-8" -->
		<javac srcdir="${dir.src}" destdir="${dir.classes}" debug="on" nowarn="on" encoding="UTF-8">
			<classpath refid="build.classpath" />
			<include name="org/psystems/dicom/daemon/**" />
			<exclude name="**/*Test.java" />
		</javac>
	</target>



	<!-- distrib -->
	<target name="distrib" depends="compile">


		<tstamp>
			<format property="today" pattern="yyyy/MM/dd HH:mm:ss" locale="en" />
		</tstamp>

		<copy todir="${dir.classes}">
			<fileset dir="${dir.src}">
				<exclude name="**/*.java" />
			</fileset>
		</copy>

		<jar destfile="${dir.distrib}/${distrib.jar}" basedir="${dir.classes}">
			<manifest>
				<attribute name="Build-By" value="${user.name}" />
				<attribute name="Build-Number" value="${revision.max}" />

				<section name="common">
					<attribute name="Specification-Title" value="Webdicom Archive" />
					<attribute name="Specification-Version" value="${today}" />
					<attribute name="Specification-Vendor" value="psystems.org" />
				</section>
			</manifest>
			<exclude name="**/*Test*" />
			<exclude name="**/log4j.properties " />
		</jar>
		<delete dir="${dir.classes}" />

	</target>


	<!-- start database -->
	<target name="db.start" description="start database">
		<mkdir dir="${dir.instance}" />
		<echo message="start database" />
		<java classname="org.apache.derby.drda.NetworkServerControl" fork="true" spawn="true">
			<arg value="start" />
			<sysproperty key="derby.system.home" value="${dir.instance}" />
			<classpath refid="derby.classpath" />
		</java>
	</target>
	
	<!-- stop database -->
		<target name="db.stop" description="stop database">
			<mkdir dir="${dir.instance}" />
			<echo message="stop database" />
			<java classname="org.apache.derby.drda.NetworkServerControl" fork="true" spawn="true">
				<arg value="shutdown" />
				<sysproperty key="derby.system.home" value="${dir.instance}" />
				<classpath refid="derby.classpath" />
			</java>
		</target>


	<!-- drop test database -->
	<target name="db.dropinstance">
		<delete includeemptydirs="yes">
			<fileset dir="${dir.instance}" />
		</delete>
	</target>

	<!-- make test database  -->
	<!-- !!! TODO сделать обработку ошибок создания БД !!!! -->
	<target name="db.makeinstance">
		<java classname="org.apache.derby.tools.ij" output="${dir.instance}/makedb.log">
			<arg value="database/derby/db.sql" />
			<sysproperty key="ij.exceptionTrace" value="true" />
			<sysproperty key="ij.showErrorCode" value="true" />
			<sysproperty key="derby.system.home" value="${dir.instance}" />
			<sysproperty key="ij.database" value="${db.connect}" />


			<classpath refid="derby.classpath" />
		</java>



		<loadfile property="db.make.has.exceptions" srcfile="${dir.instance}/makedb.log">
			<filterchain>
				<headfilter lines="1000"/>
				<containsregex pattern="Exception"/>
			</filterchain>
		</loadfile>
		<echo message="${db.make.has.exceptions}"/>


		<if>
			<isset property="db.make.has.exceptions"/>
			<then>
				<echo message="MAKE DB HAS ERROR"/>
			</then>
			<else>
			</else>
		</if>

		<fail message="MAKE DB ERROR!">
			<condition>
				<isset property="db.make.has.exceptions"/>
			</condition>
		</fail>

	</target>


	<!-- start archive -->
	<target name="archve.start" description="Запуск архива">

		<java classname="org.psystems.dicom.daemon.Archive">
			<arg value="DDV@localhost:11112" />
			<arg value="-config" />
			<arg value="distrib/dcmarcive-conf.xml" />
			<arg value="-dest" />
			<arg value="database\instance\dcm.data" />
			<arg value="-jdbcconnect" />
			<arg value="jdbc:derby://localhost:1527//DICOM/DB/WEBDICOM" />

			<classpath refid="archive.classpath" />
		</java>
	</target>

	<!-- send to archive -->
	<target name="send2archive" description="Отправка dcm-файла в архив">
		<echo message="file=${file}" />
		<java classname="org.dcm4che2.tool.dcmsnd.DcmSnd">
			<arg value="MAIN@localhost:11112" />
			<arg value="${file}" />
			<classpath refid="dcmsend.classpath" />
		</java>
	</target>

	<!-- fill database test studies -->
	<target name="db.fill" description="заливка тестовых исследваний">

		<for param="file">
			<path>
				<fileset dir="test/data" includes="**/*.dcm" />
			</path>
			<sequential>
				<antcall target="send2archive">
					<param name="file" value="@{file}" />
				</antcall>
			</sequential>
		</for>

	</target>



</project>

